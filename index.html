<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Goalink Editor - Standing Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { background: #111; color: white; font-family: 'Helvetica Neue', Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        .controls { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; width: 480px; display: flex; flex-direction: column; gap: 8px; box-sizing: border-box; }
        textarea { width: 100%; height: 100px; background: #333; color: #ccc; border: 1px solid #444; border-radius: 4px; padding: 8px; font-size: 11px; }
        button { background: #007AFF; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #capture-area { 
            width: 432px; height: 540px; background: #000; overflow: hidden; position: relative;
            display: flex; flex-direction: column; padding: 10px 12px 15px 12px; box-sizing: border-box;
        }

        .header { text-align: center; margin-bottom: 8px; border-bottom: 1.5px solid #fff; padding-bottom: 4px; }
        .league-title { font-size: 16px; font-weight: 900; letter-spacing: 0.05em; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { font-size: 9px; color: #888; padding-bottom: 4px; text-align: center; }
        td { font-size: 12px; font-weight: 800; padding: 3.8px 0; border-bottom: 1px solid #222; text-align: center; line-height: 1; }

        .col-rank { width: 22px; font-style: italic; color: #aaa; }
        .col-team { width: 175px; text-align: left; padding-left: 8px; }
        .col-m { width: 28px; color: #888; font-weight: 500; }
        .col-pts { width: 32px; color: #ff3b30; font-size: 13px; }
        .col-diff { width: 35px; }

        /* チーム名2回繰り返し対策 & 短縮表示 */
        .team-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* 順位帯カラー（J1基準：1-3位 ACL、18-20位 降格） */
        .rank-row-1, .rank-row-2, .rank-row-3 { background: rgba(0, 122, 255, 0.15); }
        .rank-row-18, .rank-row-19, .rank-row-20 { background: rgba(255, 59, 48, 0.15); }

        #res img { margin-top: 20px; width: 432px; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="controls">
        <textarea id="it" placeholder="順位表のテキストを貼り付け"></textarea>
        <button onclick="parseStanding()">1. 順位表を解析</button>
        <button onclick="takePhoto()" style="background:#34c759;">2. 画像出力</button>
    </div>

    <div id="capture-area">
        <div class="header">
            <div class="league-title" id="out-title" contenteditable="true">2025 明治安田Ｊ１リーグ 順位表</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th class="col-rank">位</th>
                    <th class="col-team">チーム</th>
                    <th class="col-m">試合</th>
                    <th class="col-pts">勝点</th>
                    <th class="col-diff">得失</th>
                </tr>
            </thead>
            <tbody id="standing-body"></tbody>
        </table>
    </div>
    <div id="res"></div>

    <script>
        // チーム名の重複（鹿島アントラーズ鹿島アントラーズ）を消し、短縮名に変換する
        function cleanTeamName(name) {
            if(!name) return "";
            // 重複をカット（例：鹿島アントラーズ鹿島アントラーズ -> 鹿島アントラーズ）
            const half = Math.floor(name.length / 2);
            if (name.substring(0, half) === name.substring(half)) {
                name = name.substring(0, half);
            }
            // 不要な「FC」などの表記ゆれを微調整（必要に応じて）
            return name.replace(/ＦＣ/g, "FC").trim();
        }

        function parseStanding() {
            const raw = document.getElementById('it').value;
            // 1行にまとまっているパターンに対応
            const lines = raw.split('\n').map(l => l.trim()).filter(l => l !== "");
            let data = [];

            lines.forEach(line => {
                // 正規表現で「順位 チーム名 数値...」を切り出す
                // 順位(数字) チーム名(日本語・英語) 数値(勝点 試合 勝 分 負 得 失 差)
                const match = line.match(/^(\d+)\s+([亜-熙ぁ-んァ-ヶa-zA-Z0-９\.\s・!？]+?)\s+([\d\s-+]+)$/);
                
                if (match) {
                    const rank = match[1];
                    const name = cleanTeamName(match[2]);
                    const nums = match[3].split(/\s+/).filter(n => n !== "");

                    if (nums.length >= 7) {
                        data.push({
                            rank: rank,
                            team: name,
                            pts: nums[0],   // 勝点
                            m: nums[1],     // 試合数
                            diff: nums[nums.length - 1] // 最後の数値が得失点差
                        });
                    }
                }
            });

            renderStanding(data);
        }

        function renderStanding(data) {
            const body = document.getElementById('standing-body');
            body.innerHTML = data.slice(0, 20).map(d => `
                <tr class="rank-row-${d.rank}">
                    <td class="col-rank">${d.rank}</td>
                    <td class="col-team"><span class="team-name" contenteditable="true">${d.team}</span></td>
                    <td class="col-m" contenteditable="true">${d.m}</td>
                    <td class="col-pts" contenteditable="true">${d.pts}</td>
                    <td class="col-diff" contenteditable="true">${parseInt(d.diff) > 0 ? '+' + d.diff : d.diff}</td>
                </tr>
            `).join('');
        }

        function takePhoto() {
            html2canvas(document.getElementById('capture-area'), { scale: 4, backgroundColor: "#000" }).then(c => {
                const res = document.getElementById('res');
                res.innerHTML = '';
                res.appendChild(new Image()).src = c.toDataURL();
            });
        }
    </script>
</body>
</html>
